<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fütterung</title>
<style>
body{font-family:Arial,sans-serif;margin:0;padding:1rem;font-size:20px}
h1{font-size:28px;margin-bottom:.5rem}
label{display:block;margin-top:.7rem}
select,input,button{font-size:20px;padding:.6rem;margin-top:.3rem;width:100%;max-width:320px}
button{cursor:pointer}
#msg{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:#4caf50;color:#fff;padding:.7rem 1.2rem;border-radius:10px;display:none}
#timer{font-size:36px;font-weight:bold;margin-top:1rem}
#stats{margin-top:1rem;padding:.7rem;border-radius:10px}
.red{background:#ffdddd}
.green{background:#ddffdd}
#history{margin-top:1rem}
table{border-collapse:collapse;width:100%;font-size:18px}
th,td{border:1px solid #ccc;padding:.4rem;text-align:left}
th{background:#eee}
</style>
</head>
<body>
<h1>Fütterung dokumentieren</h1>
<div id="msg"></div>
<label>Ration</label>
<select id="ration"></select>
<label>Anzahl Tiere</label>
<input type="number" id="anzahl">
<label>Faktor</label>
<input type="number" step="0.01" id="faktor">
<button onclick="dokumentieren()">Dokumentieren</button>
<div id="timer"></div>
<div id="stats"></div>
<div id="history">
<h2>Letzte Dokumentationen</h2>
<table>
<thead><tr><th>Zeit</th><th>Ration</th><th>Anzahl</th><th>Faktor</th></tr></thead>
<tbody id="histBody"></tbody>
</table>
</div>
<script>
// CSV Links
const rationCSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3X2pqe0ycs2bDCTIgJA-KyXbzR80hCPK0TPgM7C6fyUh_xflB_Ry2PVu2BD_lbzBSgv2YVrxFec-v/pub?gid=0&single=true&output=csv";
const fuetterCSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3X2pqe0ycs2bDCTIgJA-KyXbzR80hCPK0TPgM7C6fyUh_xflB_Ry2PVu2BD_lbzBSgv2YVrxFec-v/pub?gid=1853046882&single=true&output=csv";

// FORM URL + ENTRY IDs HIER EINTRAGEN
const formURL="https://docs.google.com/forms/d/e/1FAIpQLSe3xysbA5uxgEGDRy_lJAF2ZEDofJavgEXTlrz1POBcwMY3yw/formResponse";
// Timestamp wird automatisch von Google Forms gesetzt — kein Entry nötig
const eRation="entry.690290440";
const eAnzahl="entry.1406564399";
const eFaktor="en

// LIVE SYNC via localStorage
window.addEventListener("storage",()=>loadLastInputs());
function saveInputs(){
 localStorage.setItem("ration",ration.value);
 localStorage.setItem("anzahl",anzahl.value);
 localStorage.setItem("faktor",faktor.value);
}
function loadLastInputs(){
 ration.value=localStorage.getItem("ration")||"";
 anzahl.value=localStorage.getItem("anzahl")||"";
 faktor.value=localStorage.getItem("faktor")||"";
}

ration.onchange=anzahl.oninput=faktor.oninput=saveInputs;

async function loadRationen(){
 const t=await (await fetch(rationCSV)).text();
 const rows=t.trim().split("\n");
 ration.innerHTML="";
 rows.slice(1).forEach(r=>{
  const name=r.split(",")[0];
  if(name){const o=document.createElement("option");o.value=name;o.textContent=name;ration.appendChild(o)}
 });
 loadLastInputs();
}

let allDocs=[];
async function loadDocs(){
 const t=await (await fetch(fuetterCSV)).text();
 const rows=t.trim().split("\n");
 allDocs=rows.slice(1).map(r=>{
  const c=r.split(",");
  return{zeit:new Date(c[0]),ration:c[1],anz:c[2],f:c[3]}
 });
 renderHistory();
 calcStats();
}

function renderHistory(){
 const tb=document.getElementById("histBody");
 tb.innerHTML="";
 allDocs.slice(-10).reverse().forEach(d=>{
  const tr=document.createElement("tr");
  tr.innerHTML=`<td>${d.zeit.toLocaleString()}</td><td>${d.ration}</td><td>${d.anz}</td><td>${d.f}</td>`;
  tb.appendChild(tr);
 });
}

function calcStats(){
 const today=new Date();
 const y=new Date();y.setDate(today.getDate()-1);
 let cT=0,cY=0;
 allDocs.forEach(d=>{
  if(d.zeit.toDateString()===today.toDateString())cT++;
  if(d.zeit.toDateString()===y.toDateString())cY++;
 });
 const box=document.getElementById("stats");
 box.className=(cT===cY)?"green":"red";
 box.textContent=`Gestern: ${cY} | Heute: ${cT}`;
}

function msg(text){
 const m=document.getElementById("msg");
 m.textContent=text;
 m.style.display="block";
 setTimeout(()=>m.style.display="none",1000);
}

function vibrate(){if(navigator.vibrate)navigator.vibrate([200,100,200])}

function startTimer(){
 let s=240;
 const t=document.getElementById("timer");
 const i=setInterval(()=>{
  s--;
  t.textContent="Mischzeit: "+Math.floor(s/60)+":"+String(s%60).padStart(2,'0');
  if(s<=0){clearInterval(i);vibrate();msg("Mischzeit fertig")}
 },1000);
}

function dokumentieren(){
 const fd=new FormData();
 fd.append(eDatum,new Date().toISOString());
 fd.append(eRation,ration.value);
 fd.append(eAnzahl,anzahl.value);
 fd.append(eFaktor,faktor.value);
 fetch(formURL,{method:"POST",mode:"no-cors",body:fd});
 msg("Dokumentiert");
 vibrate();
 startTimer();
 setTimeout(loadDocs,1500);
}

loadRationen();
loadDocs();
setInterval(loadDocs,15000);
</script>
</body>
</html>
