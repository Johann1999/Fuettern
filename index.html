<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>F체tterung dokumentieren v1.9</title>
<style>
body { font-family: Arial, sans-serif; margin: 1rem; font-size: 22px; background-color: #f9f9f9; color: #333; }
h1 { font-size: 28px; margin-bottom: 1rem; text-align: center; color: #2c3e50; }
label { font-weight: bold; margin-top: 1rem; display: block; }
select, input { font-size: 22px; padding: 0.5rem; width: 100%; max-width: 300px; margin-bottom: 1rem; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
button { font-size: 24px; padding: 0.6rem; width: 100%; max-width: 300px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 1rem; }
button:hover { background-color: #45a049; }
.alert { font-size: 26px; color: green; opacity: 0; transition: opacity 0.3s; text-align: center; margin-bottom: 1rem; }
.timer { font-size: 34px; font-weight: bold; text-align: center; margin-top: 1rem; }
.stat { font-size: 24px; margin-top: 1rem; text-align: center; }
table { border-collapse: collapse; width: 100%; max-width: 400px; margin-top: 1rem; margin-bottom: 1rem; }
th, td { border: 1px solid #ccc; padding: 0.5rem; font-size: 22px; text-align: left; }
th { background-color: #ecf0f1; }
</style>
</head>
<body>

<h1>F체tterung dokumentieren v1.9</h1>

<label for="ration">Ration ausw채hlen</label>
<select id="ration"></select>

<label for="anz">Anzahl Tiere</label>
<input id="anz" type="number" min="1">

<label for="fak">Korrekturfaktor (%)</label>
<input id="fak" type="number" min="1">

<button id="saveBtn">F체tterung dokumentieren</button>

<div class="alert" id="msg">Dokumentiert</div>
<div class="timer" id="timer"></div>
<div class="stat" id="stat"></div>

<table>
<thead><tr><th>Komponente</th><th>kg</th></tr></thead>
<tbody id="tbl"></tbody>
</table>

<script>
const rationCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3X2pqe0ycs2bDCTIgJA-KyXbzR80hCPK0TPgM7C6fyUh_xflB_Ry2PVu2BD_lbzBSgv2YVrxFec-v/pub?gid=0&single=true&output=csv";
const tsCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3X2pqe0ycs2bDCTIgJA-KyXbzR80hCPK0TPgM7C6fyUh_xflB_Ry2PVu2BD_lbzBSgv2YVrxFec-v/pub?gid=267748514&single=true&output=csv";
const feedCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3X2pqe0ycs2bDCTIgJA-KyXbzR80hCPK0TPgM7C6fyUh_xflB_Ry2PVu2BD_lbzBSgv2YVrxFec-v/pub?gid=1853046882&single=true&output=csv";
const formURL = "https://docs.google.com/forms/d/e/1FAIpQLSe3xysbA5uxgEGDRy_lJAF2ZEDofJavgEXTlrz1POBcwMY3yw/formResponse";
const ENTRY_R = "entry.690290440";
const ENTRY_A = "entry.1406564399";
const ENTRY_F = "entry.373869795";

let R = {}, TS = {};
let ration = document.getElementById("ration"), anz = document.getElementById("anz"), fak = document.getElementById("fak"), tbl = document.getElementById("tbl"), msg = document.getElementById("msg"), timer = document.getElementById("timer"), stat = document.getElementById("stat");

// CSV Helper
async function csv(url){ const t = await fetch(url); return (await t.text()).trim().split("\n").map(r=>r.split(",")); }

async function init() {
  const r = await csv(rationCSV);
  const h = r[0];
  for (let i=1;i<r.length;i++){
    let name = r[i][0]; R[name]={};
    for(let j=1;j<h.length;j++){ let v=parseFloat(r[i][j]); if(v>0) R[name][h[j]]=v; }
  }

  const t = await csv(tsCSV);
  for(let i=1;i<t.length;i++) TS[t[i][1]]=parseFloat(t[i][2]);

  ration.innerHTML="";
  Object.keys(R).forEach(k=>{
    let o=document.createElement("option"); o.textContent=k; o.value=k; ration.appendChild(o);
  });
  if(ration.options.length>0) ration.selectedIndex=0;

  ration.addEventListener("change", ()=>{ berechnen(); });
  anz.addEventListener("input", berechnen);
  fak.addEventListener("input", berechnen);
  document.getElementById("saveBtn").addEventListener("click", speichern);

  await suggest();
  setInterval(statistik,5000);
}

async function suggest() {
  const rows = await csv(feedCSV);
  let r = ration.value;
  for(let i=rows.length-1;i>0;i--){
    if(rows[i][1]===r){
      if(!anz.value) anz.value = rows[i][2];
      if(!fak.value) fak.value = rows[i][3];
      break;
    }
  }
  berechnen();
}

function berechnen(){
  const r = ration.value;
  const a = parseFloat(anz.value);
  const f = parseFloat(fak.value)/100;
  tbl.innerHTML="";
  if(!a||!f) return;
  for(let c in R[r]){
    let tm=R[r][c]; let ts=TS[c]||100;
    let fm=Math.round((tm/(ts/100))*a*f);
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${c}</td><td>${fm}</td>`;
    tbl.appendChild(tr);
  }
}

async function speichern(){
  let fd=new FormData();
  fd.append(ENTRY_R,ration.value);
  fd.append(ENTRY_A,anz.value);
  fd.append(ENTRY_F,fak.value);
  await fetch(formURL,{method:"POST",mode:"no-cors",body:fd});
  msg.style.opacity=1; setTimeout(()=>msg.style.opacity=0,1000);
  navigator.vibrate([200,100,200]);
  startTimer();
  statistik();
}

function startTimer(){
  let t=240;
  timer.textContent="Mischzeit: 4:00";
  let i=setInterval(()=>{
    t--;
    let m=Math.floor(t/60); let s=(t%60).toString().padStart(2,"0");
    timer.textContent=`Mischzeit: ${m}:${s}`;
    if(t<=0){ clearInterval(i); navigator.vibrate([500,200,500]); timer.textContent="FERTIG"; }
  },1000);
}

async function statistik(){
  const rows = await csv(feedCSV);
  let today=0,yest=0;
  let d=new Date(), t0=d.toISOString().slice(0,10);
  d.setDate(d.getDate()-1); let y0=d.toISOString().slice(0,10);
  for(let i=1;i<rows.length;i++){
    let ts=rows[i][0]; if(!ts) continue;
    if(ts.startsWith(t0)) today++;
    if(ts.startsWith(y0)) yest++;
  }
  stat.innerHTML=`Heute: ${today} | Gestern: ${yest}`;
}

init();
</script>
</body>
</html>
