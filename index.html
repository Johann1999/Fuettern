<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fütterung erfassen</title>
<style>
body{font-family:Arial, sans-serif;margin:1rem}
@@ -15,20 +15,22 @@
#message{margin-top:0.5rem;color:green;font-weight:bold}
#uebersicht{margin-top:1rem;font-weight:bold}
.red{color:red;}
@keyframes blink { 50% { background-color: yellow; } }
.blink { animation: blink 1s step-start infinite; }
</style>
</head>
<body>

<h1>Fütterung erfassen1</h1>
<h1>Fütterung erfassen</h1>

<label>Ration auswählen</label>
<select id="rationSelect"></select>

<label>Anzahl Tiere</label>
<input type="number" id="anzahl" />
<input type="number" id="anzahl">

<label>Korrekturfaktor (%)</label>
<input type="number" id="faktor" />
<input type="number" id="faktor">

<button onclick="speichern()">Fütterung dokumentieren</button>

@@ -62,6 +64,7 @@ <h2>Zu fütternde Frischmasse (kg)</h2>
let rationen = {}, tsWerte = {}, letzte = {};
let timerInterval = null;

// --- CSV Laden ---
async function loadCSV(url){
const resp = await fetch(url);
return await resp.text();
@@ -71,18 +74,19 @@ <h2>Zu fütternde Frischmasse (kg)</h2>
return text.trim().split("\n").map(r=>r.split(",").map(c=>c.trim()));
}

// --- Init ---
async function init(){
// Rationen
const rText = await loadCSV(rationCSV);
const rRows = parseCSV(rText);
  const headers = rRows[0].map(h => h.trim());
  const headers = rRows[0].map(h=>h.trim());
for(let i=1;i<rRows.length;i++){
const name = rRows[i][0].trim();
if(!name) continue;
    rationen[name] = {};
    rationen[name]={};
for(let j=1;j<headers.length;j++){
const val = parseFloat(rRows[i][j]);
      if(!isNaN(val) && val>0) rationen[name][headers[j]] = val;
      if(!isNaN(val) && val>0) rationen[name][headers[j]]=val;
}
}

@@ -92,53 +96,33 @@ <h2>Zu fütternde Frischmasse (kg)</h2>
for(let i=1;i<tRows.length;i++){
const comp = tRows[i][1].trim();
const ts = parseFloat(tRows[i][2]);
    if(!isNaN(ts)) tsWerte[comp] = ts;
    if(!isNaN(ts)) tsWerte[comp]=ts;
}

  // Letzte Werte & Übersicht
  const fText = await loadCSV(fuetterCSV);
  const fRows = parseCSV(fText);
  const today = new Date().toISOString().slice(0,10); // YYYY-MM-DD
  const yesterday = new Date(Date.now()-86400000).toISOString().slice(0,10);
  let todayCount = 0, yesterdayCount = 0;
  for(let i=1;i<fRows.length;i++){
    const ration = fRows[i][1].trim();
    const date = fRows[i][0].trim().slice(0,10);
    const anz = parseFloat(fRows[i][2]);
    const fak = parseFloat(fRows[i][3]);
    if(ration && !isNaN(anz) && !isNaN(fak)){
      letzte[ration] = {anz,fak};
      if(date === today) todayCount++;
      if(date === yesterday) yesterdayCount++;
    }
  }
  document.getElementById("todayCount").textContent = todayCount;
  document.getElementById("yesterdayCount").textContent = yesterdayCount;
  if(todayCount !== yesterdayCount){
    document.getElementById("uebersicht").classList.add("red");
  } else {
    document.getElementById("uebersicht").classList.remove("red");
  }
  // Letzte Werte + Übersicht
  await updateUebersicht();

populateSelect();
}

// --- Dropdown ---
function populateSelect(){
const sel = document.getElementById("rationSelect");
  sel.innerHTML = "";
  Object.keys(rationen).sort().forEach(r => {
    const opt = document.createElement("option");
    opt.value = r;
    opt.textContent = r;
  sel.innerHTML="";
  Object.keys(rationen).sort().forEach(r=>{
    const opt=document.createElement("option");
    opt.value=r;
    opt.textContent=r;
sel.appendChild(opt);
});
  sel.selectedIndex = 0;
  sel.selectedIndex=0;
sel.addEventListener("change", suggest);
suggest();
}

// --- Vorschläge ---
function suggest(){
  const r = document.getElementById("rationSelect").value.trim();
  const r=document.getElementById("rationSelect").value.trim();
if(letzte[r]){
document.getElementById("anzahl").value = letzte[r].anz;
document.getElementById("faktor").value = letzte[r].fak;
@@ -149,64 +133,102 @@ <h2>Zu fütternde Frischmasse (kg)</h2>
berechnen();
}

// --- Berechnen ---
function berechnen(){
  const r = document.getElementById("rationSelect").value;
  const anz = parseFloat(document.getElementById("anzahl").value);
  const fak = parseFloat(document.getElementById("faktor").value)/100;
  if(!r || isNaN(anz) || isNaN(fak)) return;
  const tbody = document.getElementById("resultTable");
  tbody.innerHTML = "";
  const r=document.getElementById("rationSelect").value;
  const anz=parseFloat(document.getElementById("anzahl").value);
  const fak=parseFloat(document.getElementById("faktor").value)/100;
  if(!r||isNaN(anz)||isNaN(fak)) return;
  const tbody=document.getElementById("resultTable");
  tbody.innerHTML="";
for(let comp in rationen[r]){
    const tm = rationen[r][comp];
    const ts = tsWerte[comp] || 100;
    const fm = (tm/(ts/100)) * anz * fak;
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${comp}</td><td>${fm.toFixed(2)}</td>`;
    const tm=rationen[r][comp];
    const ts=tsWerte[comp]||100;
    const fm=(tm/(ts/100))*anz*fak;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${comp}</td><td>${fm.toFixed(2)}</td>`;
tbody.appendChild(tr);
}
}

document.getElementById("anzahl").addEventListener("input", berechnen);
document.getElementById("faktor").addEventListener("input", berechnen);

function startTimer(seconds = 240){
// --- Timer ---
function startTimer(seconds=240){
clearInterval(timerInterval);
  const timerDiv = document.getElementById("timer");
  let remaining = seconds;
  timerDiv.textContent = `Mischzeit: ${Math.floor(remaining/60)}:${(remaining%60).toString().padStart(2,'0')}`;
  timerInterval = setInterval(()=>{
  const timerDiv=document.getElementById("timer");
  let remaining=seconds;
  timerDiv.textContent=`Mischzeit: ${Math.floor(remaining/60)}:${(remaining%60).toString().padStart(2,'0')}`;
  timerInterval=setInterval(()=>{
remaining--;
if(remaining<=0){
clearInterval(timerInterval);
      timerDiv.textContent = "Mischzeit beendet!";
      timerDiv.textContent="Mischzeit beendet!";
      // Alarm: Hintergrund blinkt + Vibration
      timerDiv.classList.add("blink");
      if(navigator.vibrate){
        navigator.vibrate([500,200,500]);
      }
return;
}
    timerDiv.textContent = `Mischzeit: ${Math.floor(remaining/60)}:${(remaining%60).toString().padStart(2,'0')}`;
    timerDiv.textContent=`Mischzeit: ${Math.floor(remaining/60)}:${(remaining%60).toString().padStart(2,'0')}`;
},1000);
}

// Fütterung speichern
// --- Übersicht aktualisieren ---
async function updateUebersicht(){
  const fText=await loadCSV(fuetterCSV);
  const fRows=parseCSV(fText);
  const today=new Date().toISOString().slice(0,10);
  const yesterday=new Date(Date.now()-86400000).toISOString().slice(0,10);
  let todayCount=0, yesterdayCount=0;
  letzte={};
  for(let i=1;i<fRows.length;i++){
    const ration=fRows[i][1].trim();
    const date=fRows[i][0].trim().slice(0,10);
    const anz=parseFloat(fRows[i][2]);
    const fak=parseFloat(fRows[i][3]);
    if(ration && !isNaN(anz) && !isNaN(fak)){
      letzte[ration]={anz,fak};
      if(date===today) todayCount++;
      if(date===yesterday) yesterdayCount++;
    }
  }
  document.getElementById("todayCount").textContent=todayCount;
  document.getElementById("yesterdayCount").textContent=yesterdayCount;
  const ueb=document.getElementById("uebersicht");
  if(todayCount!==yesterdayCount){
    ueb.classList.add("red");
  } else { ueb.classList.remove("red"); }
}

// --- Speichern ---
function speichern(){
  const r = document.getElementById("rationSelect").value;
  const anz = document.getElementById("anzahl").value;
  const fak = document.getElementById("faktor").value;
  if(!r || !anz || !fak){alert("Eingaben prüfen"); return;}
  document.getElementById("formRation").value = r;
  document.getElementById("formAnzahl").value = anz;
  document.getElementById("formFaktor").value = fak;
  const r=document.getElementById("rationSelect").value;
  const anz=document.getElementById("anzahl").value;
  const fak=document.getElementById("faktor").value;
  if(!r||!anz||!fak){alert("Eingaben prüfen"); return;}
  document.getElementById("formRation").value=r;
  document.getElementById("formAnzahl").value=anz;
  document.getElementById("formFaktor").value=fak;
document.getElementById("fuetterForm").submit();

  // Meldung anzeigen und automatisch nach 1 Sekunde verschwinden lassen
  const msgDiv = document.getElementById("message");
  msgDiv.textContent = "Dokumentiert!";
  setTimeout(()=>{ msgDiv.textContent = ""; },1000);
  // Meldung automatisch nach 1 Sekunde ausblenden
  const msgDiv=document.getElementById("message");
  msgDiv.textContent="Dokumentiert!";
  setTimeout(()=>{msgDiv.textContent="";},1000);

  // Timer starten
startTimer(240);

  // Übersicht aktualisieren
  updateUebersicht();
}

// Lauter-Taste Shortcut
window.addEventListener('keydown', function(e){
  if(e.key === "AudioVolumeUp" || e.keyCode === 175){
// --- Lauter-Taste Shortcut ---
window.addEventListener('keydown',function(e){
  if(e.key==="AudioVolumeUp"||e.keyCode===175){
e.preventDefault();
speichern();
}
