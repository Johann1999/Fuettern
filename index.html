<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Fütterung erfassen</title>
<style>
body{font-family:Arial, sans-serif;margin:1rem}
label{display:block;margin-top:0.6rem}
input,select,button{padding:0.45rem;margin-top:0.3rem;width:100%;max-width:260px}
table{border-collapse:collapse;margin-top:1rem;width:100%}
th,td{border:1px solid #ccc;padding:0.4rem;text-align:left}
th{background:#f0f0f0}
#timer{margin-top:1rem;font-size:1.2rem;font-weight:bold}
</style>
</head>
<body>

<h1>Fütterung erfassen</h1>

<label>Ration auswählen</label>
<select id="rationSelect"></select>

<label>Anzahl Tiere</label>
<input type="number" id="anzahl" />

<label>Korrekturfaktor (%)</label>
<input type="number" id="faktor" />

<button onclick="speichern()">Fütterung dokumentieren</button>

<div id="timer"></div>

<h2>Zu fütternde Frischmasse (kg)</h2>
<table>
<thead><tr><th>Komponente</th><th>kg</th></tr></thead>
<tbody id="resultTable"></tbody>
</table>

<form id="fuetterForm" method="POST" action="https://docs.google.com/forms/d/e/1FAIpQLSe3xysbA5uxgEGDRy_lJAF2ZEDofJavgEXTlrz1POBcwMY3yw/formResponse" target="hidden_iframe">
  <input type="hidden" name="entry.690290440" id="formRation">
  <input type="hidden" name="entry.1406564399" id="formAnzahl">
  <input type="hidden" name="entry.373869795" id="formFaktor">
</form>
<iframe name="hidden_iframe" style="display:none;"></iframe>

<script>
// CSV Links
const rationCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3X2pqe0ycs2bDCTIgJA-KyXbzR80hCPK0TPgM7C6fyUh_xflB_Ry2PVu2BD_lbzBSgv2YVrxFec-v/pub?gid=0&single=true&output=csv";
const tsCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3X2pqe0ycs2bDCTIgJA-KyXbzR80hCPK0TPgM7C6fyUh_xflB_Ry2PVu2BD_lbzBSgv2YVrxFec-v/pub?gid=267748514&single=true&output=csv";
const fuetterCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3X2pqe0ycs2bDCTIgJA-KyXbzR80hCPK0TPgM7C6fyUh_xflB_Ry2PVu2BD_lbzBSgv2YVrxFec-v/pub?gid=1853046882&single=true&output=csv";

let rationen = {}, tsWerte = {}, letzte = {};
let timerInterval = null;

async function loadCSV(url){
  const resp = await fetch(url);
  return await resp.text();
}

function parseCSV(text){
  return text.trim().split("\n").map(r=>r.split(",").map(c=>c.trim()));
}

async function init(){
  // 1. Rationen laden
  const rText = await loadCSV(rationCSV);
  const rRows = parseCSV(rText);
  const headers = rRows[0].map(h => h.trim());
  for(let i=1;i<rRows.length;i++){
    const name = rRows[i][0].trim();
    if(!name) continue;
    rationen[name] = {};
    for(let j=1;j<headers.length;j++){
      const val = parseFloat(rRows[i][j]);
      if(!isNaN(val) && val>0) rationen[name][headers[j]] = val;
    }
  }

  // 2. TS-Werte laden
  const tText = await loadCSV(tsCSV);
  const tRows = parseCSV(tText);
  for(let i=1;i<tRows.length;i++){
    const comp = tRows[i][1].trim();
    const ts = parseFloat(tRows[i][2]);
    if(!isNaN(ts)) tsWerte[comp] = ts;
  }

  // 3. Letzte Werte aus Fuetterungen
  const fText = await loadCSV(fuetterCSV);
  const fRows = parseCSV(fText);
  for(let i=1;i<fRows.length;i++){
    const ration = fRows[i][1].trim();
    const anz = parseFloat(fRows[i][2]);
    const fak = parseFloat(fRows[i][3]);
    if(ration && !isNaN(anz) && !isNaN(fak)){
      letzte[ration] = {anz,fak};
    }
  }

  populateSelect();
}

function populateSelect(){
  const sel = document.getElementById("rationSelect");
  sel.innerHTML = "";
  Object.keys(rationen).sort().forEach(r => {
    const opt = document.createElement("option");
    opt.value = r;
    opt.textContent = r;
    sel.appendChild(opt);
  });
  sel.selectedIndex = 0;
  sel.addEventListener("change", suggest);
  suggest(); // Vorschläge für erste Ration
}

function suggest(){
  const r = document.getElementById("rationSelect").value.trim();
  if(letzte[r]){
    document.getElementById("anzahl").value = letzte[r].anz;
    document.getElementById("faktor").value = letzte[r].fak;
  } else {
    document.getElementById("anzahl").value = '';
    document.getElementById("faktor").value = '';
  }
  berechnen();
}

function berechnen(){
  const r = document.getElementById("rationSelect").value;
  const anz = parseFloat(document.getElementById("anzahl").value);
  const fak = parseFloat(document.getElementById("faktor").value)/100;
  if(!r || isNaN(anz) || isNaN(fak)) return;
  const tbody = document.getElementById("resultTable");
  tbody.innerHTML = "";
  for(let comp in rationen[r]){
    const tm = rationen[r][comp];
    const ts = tsWerte[comp] || 100;
    const fm = (tm/(ts/100)) * anz * fak;
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${comp}</td><td>${fm.toFixed(2)}</td>`;
    tbody.appendChild(tr);
  }
}

// Automatische Berechnung bei Eingabe
document.getElementById("anzahl").addEventListener("input", berechnen);
document.getElementById("faktor").addEventListener("input", berechnen);

function startTimer(seconds = 240){
  clearInterval(timerInterval);
  const timerDiv = document.getElementById("timer");
  let remaining = seconds;
  timerDiv.textContent = `Mischzeit: ${Math.floor(remaining/60)}:${(remaining%60).toString().padStart(2,'0')}`;
  timerInterval = setInterval(()=>{
    remaining--;
    if(remaining<=0){
      clearInterval(timerInterval);
      timerDiv.textContent = "Mischzeit beendet!";
      return;
    }
    timerDiv.textContent = `Mischzeit: ${Math.floor(remaining/60)}:${(remaining%60).toString().padStart(2,'0')}`;
  },1000);
}

// Fütterung speichern
function speichern(){
  const r = document.getElementById("rationSelect").value;
  const anz = document.getElementById("anzahl").value;
  const fak = document.getElementById("faktor").value;
  if(!r || !anz || !fak){alert("Eingaben prüfen"); return;}
  document.getElementById("formRation").value = r;
  document.getElementById("formAnzahl").value = anz;
  document.getElementById("formFaktor").value = fak;
  document.getElementById("fuetterForm").submit();
  alert("Dokumentiert!");
  startTimer(240); // 4 Minuten starten
}

// Shortcut: Lauter-Taste dokumentiert Fütterung
window.addEventListener('keydown', function(e){
  if(e.key === "AudioVolumeUp" || e.keyCode === 175){
    e.preventDefault();
    speichern();
  }
});

init();
</script>

</body>
</html>
